(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(6477)}])},6477:function(e,t,a){"use strict";let s;a.r(t),a.d(t,{default:function(){return b}});var r=a(5893),o=a(7294),n=a(7066),i=a(6495),l=a(3148);l.kL.register(l.jn,l.od,l.f$,l.uw,l.u,l.De,l.Gu);var c=e=>{let{weatherData:t,actualEnergy:a,onEnergyTomorrow:s}=e,[n,l]=(0,o.useState)([]),[c,d]=(0,o.useState)([]),[u,h]=(0,o.useState)(null),m=(e,t)=>f(2.04*Math.max(500,e)*Math.max(.5,1-Math.min(t,80)/100*.5)/1e3,3);(0,o.useEffect)(()=>{(()=>{try{if(!Array.isArray(t)||0===t.length)throw Error("ไม่มีข้อมูลสภาพอากาศ");let e=new Date("2025-06-04T00:00:00+07:00"),r=["จ","อ","พ","พฤ","ศ","ส","อา"],o=e.getDay(),n=[],i=[],c=e.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"/");n.push("พ ".concat(c)),i.push(a);for(let a=1;a<=6;a++){let s=new Date(e);s.setDate(e.getDate()+a);let l=r[(o+a)%7],c=s.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"/");n.push("".concat(l," ").concat(c));let d=t.find(e=>new Date(e.date).toDateString()===s.toDateString())||t[0]||{solar_intensity:500,cloud_cover:50,temperature:30,date:c},u=m(Number(d.solar_intensity)||500,Number(d.cloud_cover)||50);i.push(u)}console.log("Forecast Energies:",i),console.log("Day Labels:",n),l(i),d(n),s(i[1]||0),h(null)}catch(o){console.error("Error processing data:",o.message),h("เกิดข้อผิดพลาด: ".concat(o.message||"Unknown Error"));let e=new Date("2025-06-04T00:00:00+07:00"),t=["จ","อ","พ","พฤ","ศ","ส","อา"],a=e.getDay(),r=[];r.push("พ ".concat(e.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"/")));for(let s=1;s<=6;s++){let o=new Date(e);o.setDate(e.getDate()+s);let n=t[(a+s)%7],i=o.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"/");r.push("".concat(n," ").concat(i))}d(r),l([.01,.01,.01,.01,.01,.01,.01]),s(.01)}})()},[t,a,s]);let g=n.length>0?Math.max(...n):0,p=n.length>0?Math.min(...n):0,_=Math.max(.1,1.5*g),y=Math.min(0,.5*p),f=(e,t)=>Number(Math.round(Number(e+"e"+t))+"e-"+t);return(0,r.jsxs)("div",{style:{width:"100%",padding:0,position:"relative"},children:[u&&(0,r.jsx)("div",{style:{color:"red",marginBottom:"10px",position:"absolute",top:0},children:u}),n.length>0?(0,r.jsx)("div",{style:{height:"200px"},children:(0,r.jsx)(i.x1,{data:{labels:c,datasets:[{label:"พลังงานที่พยากรณ์ (kWh)",data:n,borderColor:"#4CAF50",backgroundColor:"rgba(76, 175, 80, 0.2)",fill:!0,tension:.2,pointRadius:3,borderWidth:2,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,min:y,max:_,grid:{color:"rgba(156, 173, 186, 0.1)"},ticks:{color:"#9cadba",font:{size:12},callback:e=>"".concat(e.toFixed(2)," kWh"),stepSize:(_-y)/5},title:{display:!0,text:"พลังงาน (kWh)",color:"#9cadba",font:{size:14}}},x:{grid:{display:!1},ticks:{color:"#9cadba",font:{size:12}},title:{display:!0,text:"วัน",color:"#9cadba",font:{size:14}}}},plugins:{legend:{display:!0,labels:{color:"#9cadba",font:{size:14}}},tooltip:{enabled:!0,backgroundColor:"#283239",titleColor:"#ffffff",bodyColor:"#9cadba",borderColor:"#3b4a54",borderWidth:1,callbacks:{label:e=>"".concat(e.parsed.y.toFixed(2)," kWh")}}}}})}):(0,r.jsx)("p",{children:"กำลังโหลดกราฟ..."})]})},d=a(836),u=a.n(d),h=e=>{let{message:t}=e;return(0,r.jsx)("div",{className:u().alertCard,children:(0,r.jsx)("p",{children:t})})},m=a(3977),g=a(61);let p=(0,m.C6)().length?(0,m.Mq)():(0,m.ZF)({apiKey:"AIzaSyDdr6O1arbBIGxB8oZGm3LE9JsE9lS5o3k",authDomain:"solar-project-49005.firebaseapp.com",projectId:"solar-project-49005",storageBucket:"solar-project-49005.firebasestorage.app",messagingSenderId:"705439795193",appId:"1:705439795193:web:5c400439d9207521829f28",measurementId:"G-T58NVVRMS5"});s=(0,g.KL)(p),console.log("Firebase messaging initialized");let _="BEa2v0RsBcyhm2gFRJiYjLlOrLrHQ3VrAsVTk2W2E9DTuW4uZYIqiC_NiHk5QJ-jBEj3mNa21ztkI09URFkxakw",y=async()=>{if(!s)return console.warn("Messaging not initialized."),null;if(!_)return console.error("Missing VAPID key. Please update vapidKey in firebase.ts"),null;try{let e=await Notification.requestPermission();if("granted"!==e)return console.warn("Notification permission denied."),null;let t=await (0,g.LP)(s,{vapidKey:_});if(!t)return console.warn("No FCM token received."),null;return console.log("FCM Token:",t),t}catch(e){return console.error("Error getting notification token:",e),null}},f=()=>new Promise(e=>{if(!s){console.warn("Notifications disabled."),e(null);return}(0,g.ps)(s,t=>{console.log("Foreground message:",t),e(t)})});var v=a(696),x=a.n(v),b=()=>{var e;let[t,a]=(0,o.useState)([]),[s,i]=(0,o.useState)(null),[l,d]=(0,o.useState)([]),[u,m]=(0,o.useState)(0),[g,p]=(0,o.useState)(0),_=(0,o.useRef)(!1),v=(0,o.useRef)(!1),b=(0,o.useRef)(!1),N=e=>{"Notification"in window&&"granted"===Notification.permission&&new Notification("แจ้งเตือนพลังงานแสงอาทิตย์",{body:e}),y().then(t=>{t&&n.Z.post("http://localhost:8090/send-notification",{token:t,title:"แจ้งเตือนพลังงานแสงอาทิตย์",body:e}).catch(e=>console.error("Error sending FCM:",e))})},w=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2e3;for(let s=0;s<t;s++)try{return await e()}catch(e){if(s===t-1)throw console.error("Failed after ".concat(t," retries: ").concat(e.message)),d(t=>[...t,"ไม่สามารถดึงข้อมูลได้: ".concat(e.message)]),N("ไม่สามารถดึงข้อมูลได้: ".concat(e.message)),e;console.warn("Retrying (".concat(s+1,"/").concat(t,") after error: ").concat(e.message)),await new Promise(e=>setTimeout(e,a))}};return(0,o.useEffect)(()=>{let e=async()=>{try{let e=await w(()=>n.Z.get("http://localhost:8090/weather?city=Bangkok",{timeout:2e4,headers:{"Content-Type":"application/json"}}));if(Array.isArray(e.data)&&e.data.length>0){a(e.data);let t=e.data[0],s=await w(()=>n.Z.post("http://localhost:8090/forecast",{solar_intensity:t.solar_intensity,temperature:t.temperature,cloud_cover:t.cloud_cover,humidity:60,wind_speed:1.39},{timeout:2e4,headers:{"Content-Type":"application/json"}}));p(s.data.energy_output);let r=await w(()=>n.Z.post("http://localhost:8090/detect-anomaly",{energy_output:s.data.energy_output,solar_intensity:t.solar_intensity},{timeout:2e4,headers:{"Content-Type":"application/json"}}));i(r.data)}else console.error("ข้อมูลสภาพอากาศไม่ถูกต้อง:",e.data),a([{solar_intensity:500,temperature:30,cloud_cover:50,date:new Date().toISOString().split("T")[0]}]),p(1.5),i({anomaly:!1,message:"ปกติ"})}catch(t){var e;console.error("Error fetching data:",(null===(e=t.response)||void 0===e?void 0:e.data)||t.message),a([{solar_intensity:500,temperature:30,cloud_cover:50,date:new Date().toISOString().split("T")[0]}]),p(1.5),i({anomaly:!1,message:"ปกติ"})}};e();let t=setInterval(e,6e4);return y().then(e=>{e&&console.log("FCM Token:",e)}),f().then(e=>{(null==e?void 0:e.notification)&&d(t=>[...t,"".concat(e.notification.title||"แจ้งเตือน",": ").concat(e.notification.body||"")])}).catch(e=>console.error("Error in FCM listener:",e)),()=>clearInterval(t)},[]),(0,o.useEffect)(()=>{if(!t.length)return;let e=t[0],a=Number(localStorage.getItem("cloudCoverThreshold")||50);if(e.cloud_cover>a&&!_.current){let e="ปริมาณเมฆสูงเกิน ".concat(a,"% อาจกระทบการผลิตพลังงาน");d(t=>[...t,e]),_.current=!0,N(e)}else e.cloud_cover<=a&&_.current&&(_.current=!1);s&&s.anomaly?v.current||(d(e=>[...e,s.message]),v.current=!0,N(s.message)):s&&!s.anomaly&&(v.current=!1,b.current=!1)},[t,s]),(0,r.jsxs)("div",{className:x().dashboardContainer,children:[(0,r.jsxs)("div",{className:x().section,children:[(0,r.jsx)("h1",{className:x().sectionTitle,children:"ภาพรวมระบบ"}),(0,r.jsx)("p",{className:x().sectionSubtitle,children:"ติดตามประสิทธิภาพและสุขภาพของระบบแผงโซล่าเซลล์ของคุณแบบเรียลไทม์"})]}),t.length>0&&(0,r.jsxs)("div",{className:x().overviewGrid,children:[(0,r.jsxs)("div",{className:x().overviewCard,children:[(0,r.jsx)("p",{className:x().cardTitle,children:"ความเข้มแสงอาทิติตย์"}),(0,r.jsxs)("p",{className:x().cardValue,children:[t[0].solar_intensity," W/m\xb2"]})]}),(0,r.jsxs)("div",{className:x().overviewCard,children:[(0,r.jsx)("p",{className:x().cardTitle,children:"อุณหภูมิ"}),(0,r.jsxs)("p",{className:x().cardValue,children:[(null===(e=t[0].temperature)||void 0===e?void 0:e.toFixed(1))||"N/A","\xb0C"]})]}),(0,r.jsxs)("div",{className:x().overviewCard,children:[(0,r.jsx)("p",{className:x().cardTitle,children:"ความชื้น"}),(0,r.jsxs)("p",{className:x().cardValue,children:[t[0].cloud_cover,"%"]})]})]}),(0,r.jsx)("div",{className:x().section,children:(0,r.jsx)("h2",{className:x().sectionTitle,children:"การพยากรณ์พลังงาน"})}),(0,r.jsxs)("div",{className:x().forecastSection,children:[(0,r.jsxs)("div",{className:x().forecastSummary,children:[(0,r.jsx)("p",{className:x().forecastLabel,children:"พลังงานที่ได้รับวันนี้"}),(0,r.jsxs)("p",{className:x().forecastValue,children:[g.toFixed(2)," kWh"]}),(0,r.jsx)("p",{className:x().forecastLabel,children:"คาดว่าวันพรุ่งนี้จะได้พลังงาน"}),(0,r.jsxs)("p",{className:x().forecastValue,children:[u.toFixed(2)," kWh"]})]}),(0,r.jsx)(c,{weatherData:t,actualEnergy:g,onEnergyTomorrow:m})]}),(0,r.jsx)("div",{className:x().section,children:(0,r.jsx)("h2",{className:x().sectionTitle,children:"การแจ้งเตือนระบบ"})}),l.length>0&&(0,r.jsx)("div",{className:x().alertsContainer,children:l.map((e,t)=>(0,r.jsx)(h,{message:e},t))}),(0,r.jsx)("div",{className:x().section,children:(0,r.jsx)("h2",{className:x().sectionTitle,children:"การตรวจจับความผิดปกติ"})}),s&&(0,r.jsxs)("div",{className:x().anomalyContainer,children:[(0,r.jsx)("p",{children:s.message}),s.anomaly&&(0,r.jsx)("p",{children:"คำแนะนำ: กรุณาตรวจสอบแผงโซล่าเซลล์"})]})]})}},836:function(e){e.exports={alertCard:"alert-card_alertCard___S__9"}},696:function(e){e.exports={dashboardContainer:"styles_dashboardContainer__hJ5zY",section:"styles_section__lbyum",sectionTitle:"styles_sectionTitle__pkiV4",sectionSubtitle:"styles_sectionSubtitle__vdxca",overviewGrid:"styles_overviewGrid__W4Vh7",overviewCard:"styles_overviewCard__G1_8T",cardTitle:"styles_cardTitle__dy0SS",cardValue:"styles_cardValue__PRxr_",cardChange:"styles_cardChange__xVSpz",forecastSection:"styles_forecastSection__cmbmr",forecastSummary:"styles_forecastSummary__w_RPN",forecastLabel:"styles_forecastLabel__2vzbx",forecastValue:"styles_forecastValue__S5wOd",forecastChange:"styles_forecastChange__HQk0W",forecastPeriod:"styles_forecastPeriod__O7Wst",forecastChangeValue:"styles_forecastChangeValue__09aRo",alertsContainer:"styles_alertsContainer__IbD5U",anomalyContainer:"styles_anomalyContainer__NPF9c"}}},function(e){e.O(0,[196,66,29,888,774,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);